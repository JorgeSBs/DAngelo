<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <title>Perfil</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500&family=Roboto:wght@500;700;900&display=swap"
        rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
</head>

<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

    <!-- Config Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDtDX0Upgn6eUWP6PWqACduw0UJSpQ7cYc",
            authDomain: "evalucacion-fb656.firebaseapp.com",
            databaseURL: "https://evalucacion-fb656-default-rtdb.firebaseio.com",
            projectId: "evalucacion-fb656",
            storageBucket: "evalucacion-fb656.appspot.com",
            messagingSenderId: "446865801864",
            appId: "1:446865801864:web:b51d561c84c62cb4a7553d"
        };
        firebase.initializeApp(firebaseConfig);
    </script>



    <!-- Topbar Start -->
    <div class="container-fluid bg-light p-0 wow fadeIn" data-wow-delay="0.1s">
        <div class="row gx-0 d-none d-lg-flex">
            <div class="col-lg-7 px-5 text-start">
                <div class="h-100 d-inline-flex align-items-center py-3 me-4">
                    <small class="fa fa-map-marker-alt text-primary me-2"></small>
                    <small>123 Street, New York, USA</small>
                </div>
                <div class="h-100 d-inline-flex align-items-center py-3">
                    <small class="far fa-clock text-primary me-2"></small>
                    <small>Lunes a Domingo : 08.00 AM - 09.00 PM</small>
                </div>
            </div>
            <div class="col-lg-5 px-5 text-end">
                <div class="h-100 d-inline-flex align-items-center py-3 me-4">
                    <small class="fa fa-phone-alt text-primary me-2"></small>
                    <small>+52 55 35-54-74-50</small>
                </div>
                <div class="h-100 d-inline-flex align-items-center">
                    <a class="btn btn-sm-square rounded-circle bg-white text-primary me-1" href=""><i
                            class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-sm-square rounded-circle bg-white text-primary me-1" href=""><i
                            class="fab fa-twitter"></i></a>
                    <a class="btn btn-sm-square rounded-circle bg-white text-primary me-1" href=""><i
                            class="fab fa-linkedin-in"></i></a>
                    <a class="btn btn-sm-square rounded-circle bg-white text-primary me-0" href=""><i
                            class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->

    <!-- Navbar Start -->
     <!-- Navbar -->
     <nav class="navbar navbar-expand-lg bg-white navbar-light sticky-top p-0 wow fadeIn">
        <a href="indexusuario.html" class="navbar-brand d-flex align-items-center px-4 px-lg-5">
            <h1 class="m-0 text-primary"><i class="far fa-hospital me-3"></i>D´angelo</h1>
        </a>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto p-4 p-lg-0">
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" id="userMenu">
                        <img src="img/placeholder-user.jpg" id="navProfilePhoto" 
                             class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                        <span id="navUserName">Usuario</span>
                    </a>
                    <div class="dropdown-menu">
                        <a href="profile.html" class="dropdown-item">Perfil</a>
                        <a class="dropdown-item" href="#" onclick="logout()">Cerrar sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- Navbar End -->

    <!-- Contenido del Perfil -->
    <div class="container-xxl py-5">
        <div class="container">
            <!-- Sección Foto de Perfil -->
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <div class="profile-photo-container mb-3">
                        <img src="img/placeholder-user.jpg" id="profilePhoto" 
                             class="rounded-circle" 
                             style="width: 150px; height: 150px; object-fit: cover;">
                        <div class="upload-overlay">
                            <input type="file" id="photoUpload" accept="image/*" class="form-control d-none">
                            <label for="photoUpload" class="btn btn-light">
                                <i class="fa fa-camera"></i>
                            </label>
                        </div>
                    </div>
                    <div id="emailVerifiedBadge" class="badge bg-success d-none">Email Verificado</div>
                    <button onclick="sendEmailVerification()" class="btn btn-link text-danger" id="verifyEmailBtn">
                        Verificar Email
                    </button>
                </div>
            </div>

            <!-- Formulario de Perfil -->
            <div class="row g-5">
                <div class="col-lg-6">
                    <h2 class="mb-4">Datos Personales</h2>
                    <div id="message" class="alert d-none"></div>
                    <form id="profileForm">
                        <div class="mb-3">
                            <label class="form-label">Método de autenticación</label>
                            <input type="text" class="form-control" id="authProvider" disabled>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="firstName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="lastName" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="phone">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-save me-2"></i>Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Sección Seguridad -->
                <div class="col-lg-6">
                    <div id="passwordSection">
                        <h3 class="mb-4">Seguridad</h3>
                        <div class="card">
                            <div class="card-body">
                                <form id="passwordForm">
                                    <div class="mb-3">
                                        <label class="form-label">Contraseña actual</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nueva contraseña</label>
                                        <input type="password" class="form-control" id="newPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Confirmar nueva contraseña</label>
                                        <input type="password" class="form-control" id="confirmPassword" required>
                                    </div>
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fa fa-lock me-2"></i>Cambiar Contraseña
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentUser = null;
        const db = firebase.firestore();
        const storage = firebase.storage();

        firebase.auth().onAuthStateChanged(async user => {
            if (!user) window.location.href = 'login.html';
            
            currentUser = user;
            await checkUserProvider();
            await loadProfileData();
            setupEmailVerification();
            setupPhotoUpload();
            updateNavProfile();
        });

        async function checkUserProvider() {
            const provider = currentUser.providerData[0].providerId;
            document.getElementById('authProvider').value = provider === 'password' ? 'Email/Contraseña' : 'Google';
            document.getElementById('passwordSection').style.display = provider === 'password' ? 'block' : 'none';
            document.getElementById('email').disabled = provider !== 'password';
        }

        async function loadProfileData() {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            
            if (!userDoc.exists) {
                await createInitialUserRecord();
                return;
            }
            
            const data = userDoc.data();
            document.getElementById('firstName').value = data.firstName || '';
            document.getElementById('lastName').value = data.lastName || '';
            document.getElementById('email').value = currentUser.email;
            document.getElementById('phone').value = data.phone || '';
            
            if (data.photoURL) {
                document.getElementById('profilePhoto').src = data.photoURL;
                document.getElementById('navProfilePhoto').src = data.photoURL;
            } else if (currentUser.photoURL) {
                document.getElementById('profilePhoto').src = currentUser.photoURL;
                document.getElementById('navProfilePhoto').src = currentUser.photoURL;
            }
        }

        async function createInitialUserRecord() {
            const providerData = currentUser.providerData[0];
            const userData = {
                firstName: providerData.displayName?.split(' ')[0] || '',
                lastName: providerData.displayName?.split(' ')[1] || '',
                email: providerData.email,
                provider: providerData.providerId,
                created: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('users').doc(currentUser.uid).set(userData);
            loadProfileData();
        }

        document.getElementById('profileForm').addEventListener('submit', async e => {
            e.preventDefault();
            try {
                await currentUser.updateProfile({
                    displayName: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`
                });
                
                await db.collection('users').doc(currentUser.uid).update({
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    phone: document.getElementById('phone').value
                });
                
                showMessage('Perfil actualizado correctamente', 'success');
                updateNavProfile();
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'danger');
            }
        });

        function setupPhotoUpload() {
            document.getElementById('photoUpload').addEventListener('change', async e => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const storageRef = storage.ref(`users/${currentUser.uid}/profile.jpg`);
                    await storageRef.put(file);
                    const photoURL = await storageRef.getDownloadURL();
                    
                    await currentUser.updateProfile({ photoURL });
                    await db.collection('users').doc(currentUser.uid).update({ photoURL });
                    
                    document.getElementById('profilePhoto').src = photoURL;
                    document.getElementById('navProfilePhoto').src = photoURL;
                    showMessage('Foto de perfil actualizada', 'success');
                } catch (error) {
                    showMessage(`Error al subir foto: ${error.message}`, 'danger');
                }
            });
        }

        function setupEmailVerification() {
            const verifyBadge = document.getElementById('emailVerifiedBadge');
            const verifyBtn = document.getElementById('verifyEmailBtn');
            
            if (currentUser.emailVerified) {
                verifyBadge.classList.remove('d-none');
                verifyBtn.classList.add('d-none');
            } else {
                verifyBadge.classList.add('d-none');
                verifyBtn.classList.remove('d-none');
            }
        }

        async function sendEmailVerification() {
            try {
                await currentUser.sendEmailVerification();
                showMessage('Email de verificación enviado. Revisa tu bandeja.', 'success');
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'danger');
            }
        }

        document.getElementById('passwordForm').addEventListener('submit', async e => {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            
            try {
                if (newPassword !== document.getElementById('confirmPassword').value) {
                    throw new Error('Las contraseñas no coinciden');
                }
                
                await currentUser.reauthenticateWithCredential(
                    firebase.auth.EmailAuthProvider.credential(
                        currentUser.email, 
                        document.getElementById('currentPassword').value
                    )
                );
                
                await currentUser.updatePassword(newPassword);
                showMessage('Contraseña actualizada correctamente', 'success');
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'danger');
            }
        });

        function updateNavProfile() {
            document.getElementById('navUserName').textContent = 
                currentUser.displayName || currentUser.email;
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `alert alert-${type} d-block`;
            setTimeout(() => messageDiv.className = 'alert d-none', 5000);
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            });
        }
    </script>
</body>

</html>